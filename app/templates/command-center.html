{% extends "base.html" %}

{% block content %}
<style>
.command-center-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 80px);
    gap: 1rem;
    padding: 1rem;
}

.dashboards-section {
    flex: 1;
    overflow-y: auto;
    background: var(--dark-surface);
    border-radius: 12px;
    padding: 2rem;
}

.chat-section {
    height: 400px;
    background: var(--dark-bg);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    border: 2px solid var(--primary-color);
    box-shadow: 0 8px 32px rgba(100, 255, 218, 0.2);
}

.chat-header {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 10px 10px 0 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input-container {
    padding: 1rem 1.5rem;
    background: rgba(255,255,255,0.03);
    border-top: 1px solid rgba(100, 255, 218, 0.2);
    display: flex;
    gap: 1rem;
}

.message {
    display: flex;
    gap: 1rem;
    animation: slideIn 0.3s ease;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    flex-shrink: 0;
}

.message.user .message-avatar {
    background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
}

.message.ai .message-avatar {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.message-content {
    max-width: 70%;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    line-height: 1.6;
}

.message.user .message-content {
    background: rgba(255, 165, 2, 0.2);
    border: 1px solid rgba(255, 165, 2, 0.3);
}

.message.ai .message-content {
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid rgba(100, 255, 218, 0.2);
}

.message-time {
    font-size: 0.8rem;
    color: var(--muted-text);
    margin-top: 0.5rem;
}

.chat-input {
    flex: 1;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(100, 255, 218, 0.3);
    border-radius: 8px;
    color: var(--text-color);
    font-size: 1rem;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.1);
}

.send-btn {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.send-btn:hover {
    transform: translateY(-2px);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.dashboard-card {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid var(--primary-color);
}

.dashboard-card h3 {
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.metric:last-child {
    border-bottom: none;
}

.metric-label {
    color: var(--muted-text);
}

.metric-value {
    color: var(--primary-color);
    font-weight: 600;
    font-size: 1.2rem;
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-online {
    background: #2ed573;
    box-shadow: 0 0 8px #2ed573;
}

.status-offline {
    background: #ff6348;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.typing-indicator {
    display: none;
    padding: 1rem 1.5rem;
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid rgba(100, 255, 218, 0.2);
    border-radius: 12px;
    width: fit-content;
}

.typing-indicator.active {
    display: flex;
    gap: 0.5rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--primary-color);
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}
</style>

<div class="command-center-container">
    <!-- Header -->
    <div style="text-align: center; margin-bottom: 1rem;">
        <h1 style="font-size: 3rem; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            âš¡ Command Center
        </h1>
        <p style="color: var(--muted-text); font-size: 1.2rem;">
            Talk to your AI operations assistant
        </p>
    </div>

    <!-- Dashboards Section -->
    <div class="dashboards-section">
        <div class="dashboard-grid">
            <!-- System Status -->
            <div class="dashboard-card">
                <h3>ðŸŸ¢ System Status</h3>
                <div id="system-status">
                    <div class="metric">
                        <span class="metric-label">
                            <span class="status-indicator status-online"></span>Dashboard
                        </span>
                        <span class="metric-value">Online</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">
                            <span class="status-indicator status-online"></span>Database
                        </span>
                        <span class="metric-value">Connected</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value" id="uptime">-</span>
                    </div>
                </div>
            </div>

            <!-- Recent Deployments -->
            <div class="dashboard-card">
                <h3>ðŸš€ Recent Deployments</h3>
                <div id="deployments">
                    <div class="metric">
                        <span class="metric-label">Last Deploy</span>
                        <span class="metric-value" id="last-deploy">Just now</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Status</span>
                        <span class="metric-value" style="color: #2ed573;">Success</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Auto-Deploy</span>
                        <span class="metric-value">Enabled</span>
                    </div>
                </div>
            </div>

            <!-- Membership Stats -->
            <div class="dashboard-card">
                <h3>ðŸ‘¥ Membership</h3>
                <div id="membership-stats">
                    <div class="metric">
                        <span class="metric-label">Total Members</span>
                        <span class="metric-value" id="total-members">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Signups Today</span>
                        <span class="metric-value" id="signups-today">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Streaks</span>
                        <span class="metric-value" id="active-streaks">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Commands -->
        <div style="margin-top: 2rem;">
            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">ðŸ’¡ Try asking me:</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 0.8rem;">
                <button class="quick-command" onclick="askQuestion('What is the deployment status?')">
                    What's the deployment status?
                </button>
                <button class="quick-command" onclick="askQuestion('How many members do we have?')">
                    How many members do we have?
                </button>
                <button class="quick-command" onclick="askQuestion('Show me system health')">
                    Show me system health
                </button>
                <button class="quick-command" onclick="askQuestion('What happened in the last hour?')">
                    What happened in the last hour?
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-header">
            <div style="font-size: 1.5rem;">ðŸ¤–</div>
            <div>
                <div style="font-weight: 600; font-size: 1.1rem;">AI Operations Assistant</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Ask me anything about your systems</div>
            </div>
            <div style="margin-left: auto;">
                <span class="status-indicator status-online"></span>
                <span style="font-size: 0.9rem;">Online</span>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="message ai">
                <div class="message-avatar">ðŸ¤–</div>
                <div>
                    <div class="message-content">
                        Hey! I'm your AI operations assistant. I can help you check system status, view deployments, manage members, and execute commands. What would you like to know?
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <input
                type="text"
                class="chat-input"
                id="chat-input"
                placeholder="Ask about deployments, members, system status..."
                onkeypress="if(event.key==='Enter') sendMessage()"
            >
            <button class="send-btn" id="send-btn" onclick="sendMessage()">
                Send âš¡
            </button>
        </div>
    </div>
</div>

<style>
.quick-command {
    padding: 0.6rem 1.2rem;
    background: rgba(100, 255, 218, 0.1);
    border: 1px solid rgba(100, 255, 218, 0.3);
    border-radius: 8px;
    color: var(--primary-color);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
}

.quick-command:hover {
    background: rgba(100, 255, 218, 0.2);
    transform: translateY(-2px);
}
</style>

<script>
let messageCount = 0;

function askQuestion(question) {
    document.getElementById('chat-input').value = question;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);
    input.value = '';

    // Show typing indicator
    showTyping();

    // Disable send button
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Thinking...';

    try {
        // Send to AI endpoint
        const response = await fetch('/api/command-center/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        // Hide typing indicator
        hideTyping();

        // Add AI response
        addMessage('ai', data.response, data.data);

        // Update dashboards if data provided
        if (data.data) {
            updateDashboards(data.data);
        }

    } catch (error) {
        hideTyping();
        addMessage('ai', 'Sorry, I encountered an error. Please try again.');
    }

    // Re-enable send button
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send âš¡';
}

function addMessage(type, content, data) {
    const messagesDiv = document.getElementById('chat-messages');
    const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const avatar = type === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

    messageDiv.innerHTML = `
        <div class="message-avatar">${avatar}</div>
        <div>
            <div class="message-content">${content}</div>
            <div class="message-time">${time}</div>
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showTyping() {
    const messagesDiv = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'message ai';
    typingDiv.innerHTML = `
        <div class="message-avatar">ðŸ¤–</div>
        <div class="typing-indicator active">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function hideTyping() {
    const typing = document.getElementById('typing-indicator');
    if (typing) typing.remove();
}

function updateDashboards(data) {
    if (data.members !== undefined) {
        document.getElementById('total-members').textContent = data.members;
    }
    if (data.signupsToday !== undefined) {
        document.getElementById('signups-today').textContent = data.signupsToday;
    }
    if (data.deploymentStatus) {
        document.getElementById('last-deploy').textContent = data.deploymentStatus;
    }
}

// Auto-update dashboards every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('/api/command-center/stats');
        const data = await response.json();
        updateDashboards(data);
    } catch (error) {
        console.error('Failed to update dashboards:', error);
    }
}, 30000);

// Load initial stats
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/command-center/stats');
        const data = await response.json();
        updateDashboards(data);
    } catch (error) {
        console.error('Failed to load initial stats:', error);
    }
});
</script>
{% endblock %}
